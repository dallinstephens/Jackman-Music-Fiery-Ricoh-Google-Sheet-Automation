#!/bin/bash

# Define the directory where this .command file is located
COMMAND_DIR="$(dirname "$0")"

# Define the actual directory of your Python script and virtual environment
SCRIPT_AND_VENV_DIR="$COMMAND_DIR/Fiery_Automation"

# Define the log file path
LOG_FILE="$SCRIPT_AND_VENV_DIR/fiery_automation.log"

# Navigate to the script's directory.
cd "$SCRIPT_AND_VENV_DIR" || { echo "ERROR: Could not navigate to $SCRIPT_AND_VENV_DIR." >&2; exit 1; }

# Clear the log file at the start of each run by using '>'
echo "--- Script started at $(date) ---" > "$LOG_FILE"
echo "Running Python script from: $(pwd)..." >> "$LOG_FILE"

# Activate the virtual environment BEFORE running the Python script
if [ -f ".venv/bin/activate" ]; then
    echo "Activating virtual environment..." >> "$LOG_FILE"
    source .venv/bin/activate >> "$LOG_FILE" 2>&1
    if [ $? -eq 0 ]; then
        echo "Virtual environment activated successfully." >> "$LOG_FILE"
    else
        echo "ERROR: Failed to activate virtual environment." >> "$LOG_FILE"
        exit 1
    fi
else
    echo "WARNING: Virtual environment not found. Running with system Python." >> "$LOG_FILE"
fi

# Run your Python script. The script itself handles the background clearing.
python fiery_automation.py >> "$LOG_FILE" 2>&1

# Deactivate the virtual environment
deactivate >> "$LOG_FILE" 2>&1
echo "Virtual environment deactivated." >> "$LOG_FILE"

echo "Python script finished executing. Terminal will close in 5 seconds." >> "$LOG_FILE"
echo "--- Script finished at $(date) ---" >> "$LOG_FILE"

# The following lines will print to the terminal window
echo ""
echo "Script finished. Terminal will close in 5 seconds."
sleep 5

# Exit the shell
exit 0